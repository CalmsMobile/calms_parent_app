import 'package:flutter/material.dart';

class InvoicePayment extends StatefulWidget {
  const InvoicePayment();
  List<Map<dynamic, dynamic>> getStoreList() {
    return [
      {
        "invoice_no": "TRA",
        "name": "James",
        "user_image": "https://randomuser.me/api/portraits/men/2.jpg",
        "class": "Y5C1",
        "description": "School fees",
        "invoice_amount": "5",
        "paid_to_date": "2",
        "outstanding_amount": "3",
        "image": [
          "http://124.217.235.107:2008/Handler/ImagePathHandler.ashx?ImagePath=StoreItems/b6fa-e4c2-2021-11-25-11-32-18-810/71-zpNFAyTL._SL1080_.jpg&Default=60&PROUrl=http://124.217.235.107:2008/&StoreageUrl=http://124.217.235.107:2008/FS/",
          "http://124.217.235.107:2008/FS/StoreItems/4adc-e4c2-2021-11-25-11-32-55-924/student-plastic-id-card-holder-500x500.jpg"
        ],
        "penalty_amount": 0,
        "invoice_date": "01-12-2021"
      },
      {
        "invoice_no": "REFF",
        "name": "James",
        "user_image": "https://randomuser.me/api/portraits/men/2.jpg",
        "class": "Y5C1",
        "description": "Transportation Fee",
        "invoice_amount": "56.50",
        "paid_to_date": "6",
        "outstanding_amount": "0",
        "image": [
          "http://124.217.235.107:2008/Handler/ImagePathHandler.ashx?ImagePath=StoreItems/b6fa-e4c2-2021-11-25-11-32-18-810/71-zpNFAyTL._SL1080_.jpg&Default=60&PROUrl=http://124.217.235.107:2008/&StoreageUrl=http://124.217.235.107:2008/FS/",
          "http://124.217.235.107:2008/FS/StoreItems/4adc-e4c2-2021-11-25-11-32-55-924/student-plastic-id-card-holder-500x500.jpg"
        ],
        "penalty_amount": 0,
        "invoice_date": "31-12-2021"
      },
      {
        "invoice_no": "TRA",
        "name": "James",
        "user_image": "https://randomuser.me/api/portraits/men/2.jpg",
        "class": "Y5C1",
        "description": "School fees",
        "invoice_amount": "20",
        "paid_to_date": "20",
        "outstanding_amount": "3",
        "image": [
          "http://124.217.235.107:2008/Handler/ImagePathHandler.ashx?ImagePath=StoreItems/b6fa-e4c2-2021-11-25-11-32-18-810/71-zpNFAyTL._SL1080_.jpg&Default=60&PROUrl=http://124.217.235.107:2008/&StoreageUrl=http://124.217.235.107:2008/FS/",
          "http://124.217.235.107:2008/FS/StoreItems/4adc-e4c2-2021-11-25-11-32-55-924/student-plastic-id-card-holder-500x500.jpg"
        ],
        "penalty_amount": 0,
        "invoice_date": "01-12-2021"
      },
      {
        "invoice_no": "TRA",
        "name": "James",
        "user_image": "https://randomuser.me/api/portraits/men/2.jpg",
        "class": "Y5C1",
        "description": "Book fees",
        "invoice_amount": "5",
        "paid_to_date": "2",
        "outstanding_amount": "3",
        "image": [
          "http://124.217.235.107:2008/Handler/ImagePathHandler.ashx?ImagePath=StoreItems/b6fa-e4c2-2021-11-25-11-32-18-810/71-zpNFAyTL._SL1080_.jpg&Default=60&PROUrl=http://124.217.235.107:2008/&StoreageUrl=http://124.217.235.107:2008/FS/",
          "http://124.217.235.107:2008/FS/StoreItems/4adc-e4c2-2021-11-25-11-32-55-924/student-plastic-id-card-holder-500x500.jpg"
        ],
        "penalty_amount": 0,
        "invoice_date": "01-12-2021"
      },
      {
        "invoice_no": "TRA",
        "name": "James",
        "user_image": "https://randomuser.me/api/portraits/men/2.jpg",
        "class": "Y5C1",
        "description": "School fees",
        "invoice_amount": "5",
        "paid_to_date": "2",
        "outstanding_amount": "3",
        "image": [
          "http://124.217.235.107:2008/Handler/ImagePathHandler.ashx?ImagePath=StoreItems/b6fa-e4c2-2021-11-25-11-32-18-810/71-zpNFAyTL._SL1080_.jpg&Default=60&PROUrl=http://124.217.235.107:2008/&StoreageUrl=http://124.217.235.107:2008/FS/",
          "http://124.217.235.107:2008/FS/StoreItems/4adc-e4c2-2021-11-25-11-32-55-924/student-plastic-id-card-holder-500x500.jpg"
        ],
        "penalty_amount": 0,
        "invoice_date": "01-12-2021"
      },
      {
        "invoice_no": "TRA",
        "name": "James",
        "user_image": "https://randomuser.me/api/portraits/men/2.jpg",
        "class": "Y5C1",
        "description": "Transportation Fee",
        "invoice_amount": "5",
        "paid_to_date": "2",
        "outstanding_amount": "3",
        "image": [
          "http://124.217.235.107:2008/Handler/ImagePathHandler.ashx?ImagePath=StoreItems/b6fa-e4c2-2021-11-25-11-32-18-810/71-zpNFAyTL._SL1080_.jpg&Default=60&PROUrl=http://124.217.235.107:2008/&StoreageUrl=http://124.217.235.107:2008/FS/",
          "http://124.217.235.107:2008/FS/StoreItems/4adc-e4c2-2021-11-25-11-32-55-924/student-plastic-id-card-holder-500x500.jpg"
        ],
        "penalty_amount": 0,
        "invoice_date": "01-12-2021"
      },
      {
        "invoice_no": "TRA",
        "name": "James",
        "user_image": "https://randomuser.me/api/portraits/men/2.jpg",
        "class": "Y5C1",
        "description": "Book fees",
        "invoice_amount": "5",
        "paid_to_date": "2",
        "outstanding_amount": "3",
        "image": [
          "http://124.217.235.107:2008/Handler/ImagePathHandler.ashx?ImagePath=StoreItems/b6fa-e4c2-2021-11-25-11-32-18-810/71-zpNFAyTL._SL1080_.jpg&Default=60&PROUrl=http://124.217.235.107:2008/&StoreageUrl=http://124.217.235.107:2008/FS/",
          "http://124.217.235.107:2008/FS/StoreItems/4adc-e4c2-2021-11-25-11-32-55-924/student-plastic-id-card-holder-500x500.jpg"
        ],
        "penalty_amount": 0,
        "invoice_date": "01-12-2021"
      },
      {
        "invoice_no": "TRA",
        "name": "James",
        "user_image": "https://randomuser.me/api/portraits/men/2.jpg",
        "class": "Y5C1",
        "description": "Tution fees",
        "invoice_amount": "5",
        "paid_to_date": "2",
        "outstanding_amount": "3",
        "image": [
          "http://124.217.235.107:2008/Handler/ImagePathHandler.ashx?ImagePath=StoreItems/b6fa-e4c2-2021-11-25-11-32-18-810/71-zpNFAyTL._SL1080_.jpg&Default=60&PROUrl=http://124.217.235.107:2008/&StoreageUrl=http://124.217.235.107:2008/FS/",
          "http://124.217.235.107:2008/FS/StoreItems/4adc-e4c2-2021-11-25-11-32-55-924/student-plastic-id-card-holder-500x500.jpg"
        ],
        "penalty_amount": 0,
        "invoice_date": "01-12-2021"
      },
      {
        "invoice_no": "TRA",
        "name": "James",
        "user_image": "https://randomuser.me/api/portraits/men/2.jpg",
        "class": "Y5C1",
        "description": "School fees",
        "invoice_amount": "5",
        "paid_to_date": "2",
        "outstanding_amount": "3",
        "image": [
          "http://124.217.235.107:2008/Handler/ImagePathHandler.ashx?ImagePath=StoreItems/b6fa-e4c2-2021-11-25-11-32-18-810/71-zpNFAyTL._SL1080_.jpg&Default=60&PROUrl=http://124.217.235.107:2008/&StoreageUrl=http://124.217.235.107:2008/FS/",
          "http://124.217.235.107:2008/FS/StoreItems/4adc-e4c2-2021-11-25-11-32-55-924/student-plastic-id-card-holder-500x500.jpg"
        ],
        "penalty_amount": 0,
        "invoice_date": "01-12-2021"
      },
      {
        "invoice_no": "TRA",
        "name": "James",
        "user_image": "https://randomuser.me/api/portraits/men/2.jpg",
        "class": "Y5C1",
        "description": "Transportation Fee",
        "invoice_amount": "15",
        "paid_to_date": "8",
        "outstanding_amount": "3",
        "image": [
          "http://124.217.235.107:2008/Handler/ImagePathHandler.ashx?ImagePath=StoreItems/b6fa-e4c2-2021-11-25-11-32-18-810/71-zpNFAyTL._SL1080_.jpg&Default=60&PROUrl=http://124.217.235.107:2008/&StoreageUrl=http://124.217.235.107:2008/FS/",
          "http://124.217.235.107:2008/FS/StoreItems/4adc-e4c2-2021-11-25-11-32-55-924/student-plastic-id-card-holder-500x500.jpg"
        ],
        "penalty_amount": 0,
        "invoice_date": "01-12-2021"
      },
    ];
  }

  @override
  _InvoicePaymentState createState() => _InvoicePaymentState();
}

class _InvoicePaymentState extends State<InvoicePayment> {
  // This list holds the data for the list view
  List<Map<dynamic, dynamic>> _foundInvoice = [];

  @override
  void initState() {
    _foundInvoice = widget.getStoreList();
    super.initState();
  }

  // This function is called whenever the text field changes
  void _runFilter(String enteredKeyword) {
    List<Map<dynamic, dynamic>> results = [];
    if (enteredKeyword.isEmpty) {
      // if the search field is empty or only contains white-space, we'll display all users
      results = widget.getStoreList();
    } else {
      results = widget
          .getStoreList()
          .where((user) => user["description"]
              .toLowerCase()
              .contains(enteredKeyword.toLowerCase()))
          .toList();
      // we use the toLowerCase() method to make it case-insensitive
    }

    // Refresh the UI
    setState(() {
      _foundInvoice = results;
    });
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
        appBar: AppBar(
          title: Text("Invoice Payment"),
          actions: [
            IconButton(
                icon: Icon(Icons.filter_alt_outlined),
                onPressed: () => {openFilterBottomSheet(context)})
          ],
        ),
        body: Container(
          child: Column(children: [
            Container(
              margin: EdgeInsets.symmetric(vertical: 5, horizontal: 10),
              child: TextField(
                onChanged: (value) => _runFilter(value),
                decoration: const InputDecoration(
                    enabledBorder: OutlineInputBorder(
                      borderSide:
                          const BorderSide(color: Colors.blue, width: 2.0),
                    ),
                    focusedBorder: OutlineInputBorder(
                      borderSide:
                          const BorderSide(color: Colors.blue, width: 2.0),
                    ),
                    labelText: 'Search',
                    hintText: 'Type here to search',
                    suffixIcon: Icon(
                      Icons.search,
                      color: Colors.blue,
                    )),
              ),
            ),
            Expanded(
              child: Container(
                width: double.infinity,
                margin: EdgeInsets.zero,
                padding: EdgeInsets.zero,
                child: ListView.builder(
                    padding: EdgeInsets.zero,
                    shrinkWrap: true,
                    physics: BouncingScrollPhysics(
                        parent: AlwaysScrollableScrollPhysics()),
                    itemCount: _foundInvoice.length,
                    itemBuilder: (BuildContext context, int index) {
                      return Column(children: <Widget>[
                        new Divider(
                          height: 0.1,
                        ),
                        ListTile(
                          leading: ClipRRect(
                            borderRadius: BorderRadius.only(
                              topLeft: Radius.circular(8.0),
                              topRight: Radius.circular(8.0),
                              bottomLeft: Radius.circular(8.0),
                              bottomRight: Radius.circular(8.0),
                            ),
                            child: _foundInvoice[index]['user_image'] != null
                                ? Image.network(
                                    _foundInvoice[index]['user_image'],
                                    // width: 300,
                                    height: 100,
                                    fit: BoxFit.fill)
                                : Image.asset("assets/images/user.png"),
                          ),
                          title: Text(
                            _foundInvoice[index]['name'],
                            overflow: TextOverflow.ellipsis,
                            style: TextStyle(
                                fontWeight: FontWeight.bold, fontSize: 14),
                          ),
                          subtitle: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              SizedBox(
                                height: 5,
                              ),
                              Text(
                                _foundInvoice[index]['description'],
                                overflow: TextOverflow.ellipsis,
                                maxLines: 2,
                                style: TextStyle(
                                    fontWeight: FontWeight.bold, fontSize: 12),
                              ),
                              SizedBox(
                                height: 5,
                              ),

                              Text(
                                'MYR ${double.parse(_foundInvoice[index]['invoice_amount']).toStringAsFixed(2)}',
                                style: TextStyle(
                                    fontSize: 14, fontWeight: FontWeight.bold),
                              ),
                              SizedBox(
                                height: 5,
                              ),

                              new RichText(
                                text: new TextSpan(
                                  text: "Due date :",
                                  style: new TextStyle(
                                    fontSize: 12.0,
                                    color: isPaid(
                                            _foundInvoice[index]
                                                ["invoice_amount"],
                                            _foundInvoice[index]
                                                ["paid_to_date"])
                                        ? Colors.green
                                        : Colors.red,
                                  ),
                                  children: <TextSpan>[
                                    new TextSpan(
                                        text: _foundInvoice[index]
                                                    ['invoice_date']
                                                ?.toString() ??
                                            _foundInvoice[index]
                                                ['invoice_date'],
                                        style: new TextStyle(
                                            fontSize: 12,
                                            fontWeight: FontWeight.bold)),
                                  ],
                                ),
                              ),
                              // Text(storeList[index]['invoice_date'])
                            ],
                          ),
                          isThreeLine: true,
                          trailing: Column(
                            children: [
                              SizedBox(
                                height: 25,
                                width: 80,
                                child: ElevatedButton(
                                  style: ElevatedButton.styleFrom(
                                      primary: isPaid(
                                              _foundInvoice[index]
                                                  ["invoice_amount"],
                                              _foundInvoice[index]
                                                  ["paid_to_date"])
                                          ? Colors.green
                                          : Colors.red,
                                      padding: EdgeInsets.zero),
                                  onPressed: () => {},
                                  child: Text(isPaid(
                                          _foundInvoice[index]
                                              ["invoice_amount"],
                                          _foundInvoice[index]["paid_to_date"])
                                      ? "Paid"
                                      : "Pending"),
                                ),
                              ),
                              SizedBox(
                                height: 6,
                              ),
                              isPaid(_foundInvoice[index]["invoice_amount"],
                                      _foundInvoice[index]["paid_to_date"])
                                  ? Text("")
                                  : SizedBox(
                                      height: 25,
                                      width: 25,
                                      child: ClipOval(
                                        child: Material(
                                          color: Colors
                                              .transparent, // Button color
                                          child: InkWell(
                                            splashColor:
                                                Colors.red, // Splash color
                                            onTap: () {
                                              openDonationBottomSheet(context,
                                                  _foundInvoice[index]);
                                            },
                                            child: Icon(
                                              Icons.shopping_cart_outlined,
                                              color: Theme.of(context)
                                                  .primaryColor,
                                              size: 18,
                                            ),
                                          ),
                                        ),
                                      ),
                                    ),
                            ],
                          ),
                          onTap: () => {
                            Navigator.of(context).pushNamed('/InvoiceDetails',
                                arguments: _foundInvoice[index])
                          },
                        )
                      ]);
                    }),
              ),
            )
          ]),
        ));
  }

  void openFilterBottomSheet(BuildContext buildContext) {
    showModalBottomSheet(
        context: buildContext,
        builder: (context) {
          print("bottomsheet clicked");
          return Column(
            mainAxisSize: MainAxisSize.min,
            children: <Widget>[
              AppBar(
                title: Text("Filter"),
                automaticallyImplyLeading: false,
                actions: [
                  IconButton(
                    icon: Icon(Icons.close_sharp),
                    onPressed: () {
                      Navigator.pop(context);
                    },
                  ),
                ],
              ),
              Align(
                alignment: Alignment.topLeft,
                child: Container(
                  padding: EdgeInsets.symmetric(vertical: 15, horizontal: 20),
                  child: Text(
                    "Pending",
                    style: TextStyle(fontSize: 16),
                  ),
                ),
              ),
              Container(
                padding: EdgeInsets.symmetric(horizontal: 20),
                child: Divider(
                  height: 0.3,
                  color: Colors.grey,
                ),
              ),
              Align(
                alignment: Alignment.topLeft,
                child: Container(
                  padding: EdgeInsets.symmetric(vertical: 15, horizontal: 20),
                  child: Text(
                    "Paid",
                    style: TextStyle(fontSize: 16),
                  ),
                ),
              ),
            ],
          );
        });
  }
}

bool isPaid(String totalAmount, String paidAmount) {
  return double.parse(paidAmount) >= double.parse(totalAmount);
}

void openDonationBottomSheet(BuildContext buildContext, invoice) {
  showModalBottomSheet(
      context: buildContext,
      builder: (context) {
        print("bottomsheet clicked");
        return Column(
          mainAxisSize: MainAxisSize.min,
          children: <Widget>[
            AppBar(
              title: Text("Payment Summary"),
              automaticallyImplyLeading: false,
              actions: [
                IconButton(
                  icon: Icon(Icons.close_sharp),
                  onPressed: () {
                    Navigator.pop(context);
                  },
                ),
              ],
            ),
            Align(
              alignment: Alignment.center,
              child: Container(
                padding: EdgeInsets.symmetric(vertical: 10),
                child: Text(
                  invoice["description"],
                  style: TextStyle(fontWeight: FontWeight.bold, fontSize: 18),
                ),
              ),
            ),
            Container(
              padding: EdgeInsets.symmetric(vertical: 10, horizontal: 15),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Text(
                    "Invoice Amount",
                    style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14),
                  ),
                  Text(
                    'MYR ${double.parse(invoice['invoice_amount']).toStringAsFixed(2)}',
                    style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14),
                  ),
                ],
              ),
            ),
            Container(
              padding: EdgeInsets.symmetric(vertical: 10, horizontal: 15),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Text(
                    "Already you have paid",
                    style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14),
                  ),
                  Text(
                    'MYR ${double.parse(invoice['paid_to_date']).toStringAsFixed(2)}',
                    style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14),
                  ),
                ],
              ),
            ),
            Container(
              padding: EdgeInsets.symmetric(vertical: 10, horizontal: 15),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Text(
                    "Pay amount",
                    style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14),
                  ),
                  Container(
                    height: 40,
                    width: 150,
                    child: TextField(
                      style: TextStyle(fontSize: 14),
                      keyboardType: TextInputType.number,
                      textAlign: TextAlign.center,
                      decoration: const InputDecoration(
                        hintText: 'Amount',
                        border: OutlineInputBorder(),
                        contentPadding: EdgeInsets.only(
                            left: 10, right: 0, top: 0, bottom: 0),
                      ),
                    ),
                  ),
                ],
              ),
            ),
            AppBar(
              title: Align(
                alignment: Alignment.centerRight,
                child: Text(
                  "Done",
                  textAlign: TextAlign.end,
                ),
              ),
              automaticallyImplyLeading: false,
              actions: [
                IconButton(
                  icon: Icon(Icons.check_sharp),
                  onPressed: () {
                    Navigator.pop(context);
                  },
                ),
              ],
            ),
          ],
        );
      });
}
